<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Sale konferencyjne - SpaceControll</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
</head>
<body>
<div th:replace="~{fragments.html :: menu}"></div>
<div class="container mt-4">
    <h2>Dostępne sale konferencyjne</h2>
    <div th:if="${info}" class="alert alert-success" th:text="${info}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
    <!-- Informacja, gdy nie ma żadnej sali -->
    <div th:if="${#lists.isEmpty(rooms)}" class="alert alert-info">
        Aktualnie brak zdefiniowanych sal konferencyjnych w systemie.
        <!-- Możesz dodać: tylko admin widzi link do dodania sali -->
        <!-- Porównuj enum przez .name() -->
        <div class="col-auto" sec:authorize="hasAuthority('ADMIN')">
            <a class="btn btn-primary" th:href="@{/rooms/add}">Dodaj salę konferencyjną</a>
        </div>
    </div>

    <div class="alert alert-secondary" sec:authorize="isAuthenticated()">
        Zalogowany użytkownik: <span sec:authentication="name"></span> /
        Rola: <span sec:authentication="principal.authorities"></span>
    </div>

    <!-- Główna sekcja   -->
    <div th:unless="${#lists.isEmpty(rooms)}">
        <form method="get" th:action="@{/rooms}" class="row g-3 align-items-end mb-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="col-auto">
                <label for="from" class="form-label mb-0">Od:</label>
                <input type="datetime-local" class="form-control" id="from" name="from"
                       th:value="${fromString}"/>
            </div>
            <div class="col-auto">
                <label for="to" class="form-label mb-0">Do:</label>
                <input type="datetime-local" class="form-control" id="to" name="to"
                       th:value="${toString}"/>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">Sprawdź dostępność</button>
            </div>
            <!-- Przycisk "Dodaj salę" tylko dla admina-->
            <div class="col"></div>
            <div class="col-auto" sec:authorize="hasAuthority('ADMIN')">
                <a class="btn btn-primary" th:href="@{/rooms/add}">Dodaj salę konferencyjną</a>
            </div>
        </form>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Nazwa</th>
                <th>Lokalizacja</th>
                <th>Pojemność</th>
                <th>Udogodnienia</th>
                <th>Status</th>
                <th>Akcja</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="room : ${rooms}">
                <td th:text="${room.name}"></td>
                <td th:text="${room.location}"></td>
                <td th:text="${room.capacity}"></td>
                <td th:text="${room.equipment}"></td>
                <td>
                    <span th:if="${availabilityMap[room.id]}">Wolna</span>
                    <span th:if="${!availabilityMap[room.id]}">Zajęta</span>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <!-- Przycisk zarezerwuj salę - tylko dla admina -->
                        <a th:if="${availabilityMap[room.id]}"
                           th:href="@{'/reservations/create/' + ${room.id} + '?from=' + ${fromString} + '&to=' + ${toString}}"
                           class="btn btn-success btn-sm">Zarezerwuj</a>
                        <button th:unless="${availabilityMap[room.id]}"
                                class="btn btn-secondary btn-sm" disabled>Zarezerwuj
                        </button>
                        <!-- Przycisk edycji sali - tylko dla admina -->
                        <a sec:authorize="hasAuthority('ADMIN')" th:href="@{'/rooms/edit/' + ${room.id}}"
                           class="btn btn-warning btn-sm">Edytuj</a>
                        <!-- Przycisk usuwania sali - tylko dla admina -->
                        <form sec:authorize="hasAuthority('ADMIN')"
                        th:action="@{'/rooms/delete/' + ${room.id}}" method="post"
                        onsubmit="return confirm('Czy na pewno chcesz usunąć tę salę konferencyjną? Ta operacja jest nieodwracalna.');">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-danger btn-sm">Usuń</button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
